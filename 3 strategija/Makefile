# ============================================
# Makefile - Student≈≥ Valdymo Sistema v2.0
# ============================================

# Kompiliatorius ir flag≈≥ nustatymai
CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -pedantic -O2

# Programos pavadinimas
TARGET = programa

# Source failai (PAKEISKITE pagal savo failus)
SOURCES = main.cpp studentas.cpp failai.cpp
OBJECTS = $(SOURCES:.cpp=.o)

# Header failai
HEADERS = studentas.h zmogus.h failai.h rusiavimas.h

# Test≈≥ failai
TEST_TARGET = programa_tests
TEST_SOURCES = test_studentas.cpp studentas.cpp failai.cpp
TEST_OBJECTS = $(TEST_SOURCES:.cpp=.o)

# Google Test bibliotekos (jei ƒØdiegtos sistemoje)
# Jei neturite, komentuokite ≈°ias eilutes ir naudokite tik CMake testams
TEST_LIBS = -lgtest -lgtest_main -lpthread

# ============================================
# PAGRINDINIAI TIKSLAI
# ============================================

# Numatytasis tikslas - sukompiliuoti programƒÖ
all: $(TARGET)
	@echo "‚úÖ Kompiliavimas baigtas!"
	@echo "Paleiskite: ./$(TARGET)"

# Kompiliuoti pagrindinƒô programƒÖ
$(TARGET): $(OBJECTS)
	@echo "üîó Linkinami failai..."
	$(CXX) $(CXXFLAGS) -o $@ $^
	@echo "‚úÖ Programa sukurta: $(TARGET)"

# Kompiliuoti objektinius failus
%.o: %.cpp $(HEADERS)
	@echo "üî® Kompiliuojama: $<"
	$(CXX) $(CXXFLAGS) -c $< -o $@

# ============================================
# TESTAI
# ============================================

# Kompiliuoti ir paleisti testus
test: $(TEST_TARGET)
	@echo ""
	@echo "üß™ Paleid≈æiami testai..."
	@echo "================================"
	./$(TEST_TARGET)
	@echo "================================"

# Kompiliuoti test≈≥ programƒÖ
$(TEST_TARGET): $(TEST_OBJECTS)
	@echo "üîó Kompiliuojami testai..."
	@if command -v g++ >/dev/null 2>&1; then \
		$(CXX) $(CXXFLAGS) -o $@ $^ $(TEST_LIBS) 2>/dev/null || \
		(echo "‚ö†Ô∏è  Google Test nerastas. Naudokite CMake testams:" && \
		 echo "   mkdir build && cd build" && \
		 echo "   cmake .. -DBUILD_TESTS=ON" && \
		 echo "   cmake --build ." && \
		 echo "   ctest" && \
		 exit 1); \
	fi
	@echo "‚úÖ Testai sukompiliuoti: $(TEST_TARGET)"

# Kompiliuoti test objektinius failus
test_studentas.o: test_studentas.cpp $(HEADERS)
	@echo "üî® Kompiliuojami testai: $<"
	@$(CXX) $(CXXFLAGS) -c $< -o $@ 2>/dev/null || \
		(echo "‚ö†Ô∏è  Nepavyko kompiliuoti test≈≥. Naudokite CMake." && exit 1)

# ============================================
# DOKUMENTACIJA
# ============================================

# Generuoti Doxygen dokumentacijƒÖ
doc:
	@echo "üìö Generuojama dokumentacija..."
	@if command -v doxygen >/dev/null 2>&1; then \
		doxygen Doxyfile && \
		echo "‚úÖ Dokumentacija sukurta: doxygen/html/index.html" && \
		echo "Atidaryti: firefox doxygen/html/index.html"; \
	else \
		echo "‚ùå Doxygen nerastas!"; \
		echo "ƒÆdiekite: sudo apt-get install doxygen graphviz"; \
		exit 1; \
	fi

# Atidaryti dokumentacijƒÖ nar≈°yklƒóje
doc-open: doc
	@if [ -f doxygen/html/index.html ]; then \
		xdg-open doxygen/html/index.html 2>/dev/null || \
		open doxygen/html/index.html 2>/dev/null || \
		firefox doxygen/html/index.html 2>/dev/null || \
		echo "Atidaryti rankiniu b≈´du: doxygen/html/index.html"; \
	fi

# ============================================
# VALYMAS
# ============================================

# I≈°valyti kompiliuotus failus
clean:
	@echo "üßπ Valoma..."
	rm -f $(OBJECTS) $(TEST_OBJECTS)
	rm -f $(TARGET) $(TEST_TARGET)
	rm -f *.o
	@echo "‚úÖ Objektiniai failai i≈°valyti"

# I≈°valyti viskƒÖ (su dokumentacija ir rezultatais)
clean-all: clean
	@echo "üßπ Trinama visa..."
	rm -rf doxygen/
	rm -f *.txt
	rm -f stud*.txt vargsiukai.txt
	@echo "‚úÖ Viskas i≈°valyta"

# ============================================
# PAGALBA IR NAUDINGOS KOMANDOS
# ============================================

# Parodyti pagalbƒÖ
help:
	@echo "=========================================="
	@echo "Student≈≥ Valdymo Sistema v2.0 - Makefile"
	@echo "=========================================="
	@echo ""
	@echo "üìå PAGRINDINIAI TIKSLAI:"
	@echo "  make              - Kompiliuoti programƒÖ"
	@echo "  make all          - Tas pats kaip 'make'"
	@echo "  make test         - Kompiliuoti ir paleisti testus"
	@echo "  make doc          - Generuoti dokumentacijƒÖ"
	@echo "  make doc-open     - Generuoti ir atidaryti dokumentacijƒÖ"
	@echo "  make clean        - I≈°trinti kompiliuotus failus"
	@echo "  make clean-all    - I≈°trinti viskƒÖ"
	@echo "  make help         - Parodyti ≈°iƒÖ pagalbƒÖ"
	@echo ""
	@echo "üìå NAUDOJIMO PAVYZD≈ΩIAI:"
	@echo "  make && ./$(TARGET)           - Kompiliuoti ir paleisti"
	@echo "  make test                      - Paleisti testus"
	@echo "  make doc                       - Sukurti dokumentacijƒÖ"
	@echo "  make clean && make             - Perprogramuoti nuo nulio"
	@echo ""
	@echo "üìå REIKALAVIMAI:"
	@echo "  - g++ su C++17 palaikymu"
	@echo "  - Google Test (testams, pasirinktinai)"
	@echo "  - Doxygen (dokumentacijai, pasirinktinai)"
	@echo ""

# Paleisti programƒÖ po kompiliavimo
run: $(TARGET)
	@echo ""
	@echo "üöÄ Paleid≈æiama programa..."
	@echo "================================"
	./$(TARGET)

# Kompiliuoti ir i≈° karto paleisti
quick: clean all run

# Patikrinti fail≈≥ strukt≈´rƒÖ
check:
	@echo "üìã Tikrinami failai..."
	@echo ""
	@echo "Source failai:"
	@ls -1 *.cpp 2>/dev/null || echo "  ‚ùå .cpp fail≈≥ nerasta"
	@echo ""
	@echo "Header failai:"
	@ls -1 *.h 2>/dev/null || echo "  ‚ùå .h fail≈≥ nerasta"
	@echo ""
	@echo "Build sistema:"
	@ls -1 Makefile CMakeLists.txt 2>/dev/null || echo "  ‚ö†Ô∏è  Build fail≈≥ nerasta"
	@echo ""
	@echo "Dokumentacija:"
	@ls -1 Doxyfile mainpage.dox 2>/dev/null || echo "  ‚ö†Ô∏è  Doxygen fail≈≥ nerasta"
	@echo ""

# Statistika
stats:
	@echo "üìä Kodo statistika:"
	@echo ""
	@echo "Source fail≈≥ eilutƒós:"
	@wc -l *.cpp 2>/dev/null | tail -1 || echo "  N/A"
	@echo ""
	@echo "Header fail≈≥ eilutƒós:"
	@wc -l *.h 2>/dev/null | tail -1 || echo "  N/A"
	@echo ""
	@echo "Bendrai eiluƒçi≈≥:"
	@wc -l *.cpp *.h 2>/dev/null | tail -1 || echo "  N/A"

# ============================================
# PHONY TIKSLAI (nƒóra tikri failai)
# ============================================

.PHONY: all clean clean-all test doc doc-open help run quick check stats

# ============================================
# PASTABOS
# ============================================
# 
# 1. Jei Google Test neƒØdiegtas, naudokite CMake testams:
#    mkdir build && cd build
#    cmake .. -DBUILD_TESTS=ON
#    cmake --build .
#    ctest
#
# 2. Jei Doxygen neƒØdiegtas:
#    sudo apt-get install doxygen graphviz  # Linux
#    brew install doxygen graphviz          # macOS
#
# 3. Makefile jautrus tabuliacijai! ƒÆsitikinkite, kad
#    komandos pradedamos TAB, ne tarpais.
#